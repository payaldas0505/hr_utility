{% extends 'user_authentication/base.html' %}
{% load static %}

{% block content %}
<div id="Dashboard_main">
    <h3 class="dashboard_label header">Document Dashboard</h2>
        <br>
        <a href="/usermanagement/add_user_page/" class="add_user waves-effect waves-light btn"
            style="margin-bottom: -124px;"><i class="material-icons left">add_circle</i><span
                class="add_user_button">Document</span></a>



        <script src="/static/js/logout.js"></script>
        <script src="/static/js/get_refresh_token.js"></script>
        <script src="/static/js/main_dashboard.js"></script>
        <script>

            function getData() {
                $.ajax({
                    url: '/dashboard_data/',
                    headers: { Authorization: 'Bearer ' + userDetails.access },
                    type: 'GET',

                    success: function (response) {
                    },
                    error: function (xhr) {
                        if (xhr.status == 401) {
                            getaccessTokenForMainDashboard();
                            // alert("yes changed")
                        }
                        if (xhr.status == 403) {
                            logout();
                        }
                    }
                });
            }

            $(document).ready(function () {
                var userDetails = getValues('UserDetails')
                var access = userDetails.access

                getData();

                $('select').formSelect();
                // Check username avaliable in database
                $('#user_name_edit').on('blur', function () {
                    var user_name = $('#user_name_edit').val();
                    if (user_name == '') {
                        user_name_state = false;
                        return;
                    }
                    $.ajax({
                        url: '/user/check_username/',
                        type: 'post',
                        data: {
                            'user_name_check': 1,
                            'user_name': user_name,
                        },
                        success: function (response) {

                            if (response.message == 'taken') {
                                user_name_state = false;
                                $('#user_name_edit').addClass("invalid");
                                M.toast({ html: response.toast_msg, classes: 'red rounded' })
                            }
                            else if (response.message == 'not_taken') {
                                username_state = true;
                                $('#user_name_edit').addClass("valid");
                                M.toast({ html: response.toast_msg, classes: 'green darken-1 rounded' })
                            }
                        },
                        error: function (xhr) {
                            parsed_jsondata = JSON.parse(xhr.responseText)
                            // alert(parsed_jsondata.error)
                            M.toast({ html: parsed_jsondata.error, classes: 'red rounded' })
                        }
                    });
                });

                // Check emailid avaliable in database
                $('#email_edit').on('blur', function () {
                    var email = $('#email_edit').val();
                    if (email == '') {
                        email_state = false;
                        return;
                    }
                    $.ajax({
                        url: '/user/check_email/',
                        type: 'post',
                        data: {
                            'email_check': 1,
                            'email': email,
                        },
                        success: function (response) {
                            if (response.message == 'taken') {
                                email_state = false;
                                $('#email_edit').addClass("invalid");
                                M.toast({ html: response.toast_msg, classes: 'red rounded' })
                            }
                            else if (response.message == 'not_taken') {
                                email_state = true;
                                $('#email_edit').addClass("valid");
                            }

                        },
                        error: function (xhr) {
                            parsed_jsondata = JSON.parse(xhr.responseText)
                            // alert(parsed_jsondata.error)
                            M.toast({ html: parsed_jsondata.error, classes: 'red rounded' })
                        }
                    });
                });
            });
        </script>

        {% endblock %}